import matplotlib.pyplot as plt
import numpy as np
from fixedpoint import FixedPoint
from scipy.signal import butter, lfilter
from scipy import signal
from numpy import pi
from scipy.fft import fft, fftfreq, fftshift
import fixedpoint
import math

# Constants

MHz = lambda f: f * 1000000
GHz = lambda f: f * 1000000

channel_index = 0
F_RF = MHz(2402 + 2 * channel_index) # 2.402 GHz
F_IF = MHz(2.5)  # 2.5 MHz
F_LO = F_RF - F_IF # LO frequency is RF frequency - Intermediate Frequency
F_IM = F_LO - F_IF # Image is on the other side of the LO
analog_F_sample = (F_LO * 2 + F_IF) * 2
ADC_sample_rate = MHz(20)
t_interval = 0.00001

HB_coeff = [-0.0000,    0.0001,    0.0000,   -0.0009,   -0.0000,    0.0040,    0.0000,   -0.0128,   -0.0000, 0.0340,    0.0000,   -0.0850,   -0.0000,    0.3106,    0.5000,    0.3106,   -0.0000,   -0.0850, 0.0000,    0.0340,  -0.0000,   -0.0128,    0.0000,    0.0040,   -0.0000,   -0.0009,    0.0000, 0.0001,   -0.0000]
""" Method of obtaining Hilbert Transform FIR coefficients
https://www.wirelessinnovation.org/assets/Proceedings/2011/2011-1b-carrick.pdf
"""

HB_coeff = [2 * np.sin(i * pi / 2) * HB_coeff[i] for i in range(0, len(HB_coeff))]
#print(HB_coeff)

#HB_coeff = [0.0, 0.0, 0.0, 0.002, 0.0, 0.008, 0.0, 0.026, 0.0, 0.068, 0.0, 0.17, 0.0, 0.6212, 0.0, -0.6212, 0.0, -0.17, 0.0, -0.068, 0.0, -0.026, 0.0, -0.008, 0.0, -0.002, 0.0, 0.0, 0.0]

HB_coeff = [FixedPoint(c, True, 1, 11, str_base=2) for c in HB_coeff]
print(['b' + str(c) for c in HB_coeff])
def butter_lowpass(cutoff, fs, order=5):
    sos = signal.butter(10, cutoff, 'lp', fs=fs, output='sos')
    return sos

def butter_lowpass_filter(data, cutoff, fs, order=5):
    sos = butter_lowpass(cutoff, fs, order=order)
    y = signal.sosfilt(sos, data)
    return y

def frequency_plot(wave, F_sample):
    yf = fft(wave)
    xf = fftfreq(int(F_sample *t_interval), 1 / F_sample)
    print("X:",len(xf))
    xf = fftshift(xf)
    yplot = fftshift(yf)
    plt.plot(xf, 1.0/int(F_sample *t_interval) * abs(yplot))
    plt.grid()
    
def fir(signal):
    print(len(signal))
    elements = [0 for _ in range(len(HB_coeff) - 1)]
    elements.extend(signal)
    result = []
    for i in range(len(signal)):
        e = 0
        for j in range(len(HB_coeff)):
            e += HB_coeff[j] * elements[i + len(HB_coeff) - j - 1]
        result.append(e)
    return result[len(HB_coeff):]

def RF(t):
    return np.cos(2 * pi * (F_LO + F_IF) * t + pi / 4)
    
def IM(t):
    return np.cos(2 * pi * (F_LO - F_IF) * t + pi / 4)
    
def mix(signal):
    def I(t):
        return signal(t) * np.cos(2 * pi * F_LO * t)
    def Q(t):
        return signal(t) * np.sin(2 * pi * F_LO * t)
    return I, Q
    
def quantize(s, scale, range):
    return int((s - scale) / range * 31)#TODO
    
def ADC_sampling(sig, F_sample, OLD_F_sample):
    """
        Takes in signals `I` & `Q` sampled at `OLD_F_sample` and resamples them at a new sampling
    frequency `F_sample`.
    """
    sig_sampled = [quantize(s, min(sig), max(sig) - min(sig)) for s in sig[::int(OLD_F_sample//F_sample)]] # resample & quantize I
    num_samples = int(F_sample * t_interval) # determine the number of samples in the time interval
    max_valid_sample = min(num_samples, len(sig_sampled))
    results = np.linspace(0, t_interval, num_samples)[:max_valid_sample], sig_sampled[:max_valid_sample] # remove extraneous elements
    return results


def analog_lowpass(I, Q):
    return butter_lowpass_filter(I, F_IF + MHz(1), analog_F_sample), butter_lowpass_filter(Q, F_IF + MHz(1), analog_F_sample)
    
def hilbert_transform(Q):
    signal = Q
    elements = [0 for _ in range(len(HB_coeff))]
    elements.extend(signal)
    result = []
    for i in range(len(signal)):
        e = 0
        for j in range(len(HB_coeff)):
            e += HB_coeff[j] * elements[i + len(HB_coeff) - j - 1]
        result.append(e)
    return result

t = np.linspace(0, t_interval, num = int(analog_F_sample *t_interval))
I, Q = mix(lambda t: RF(t))
I, Q = I(t), Q(t)
I, Q = analog_lowpass(I, Q)
result = ADC_sampling(I, MHz(20), analog_F_sample)
print("i = ", result[1])
t = result[0]
I = [s - 15 for s in result[1]]
result = ADC_sampling(Q, MHz(20), analog_F_sample)
print("q = ", result[1])
Q = [s - 15 for s in result[1]]
I = [FixedPoint(s, True, 6, 0) for s in I]
Q = [FixedPoint(s, True, 6, 0) for s in Q]

data = [19, -3, -23, -28, -16, 6, 25, 28, 15, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -5, -22, -26, -14, 5, 23, 28, 17, -3, -22, -26, -16, 5, 23, 28, 17, -3, -22, -26, -16, 5, 23, 28, 17, -3, -22, -26, -16, 5, 23, 28, 17, -3, -22, -26, -16, 5, 23, 28, 17, -3, -22, -26, -16, 5, 23, 28, 17, -3, -22, -26, -16, 5, 23, 28, 17, -3, -22, -26, -16, 5, 23, 28, 17, -3, -22, -26]

ht = hilbert_transform(Q)
#plt.plot(list(range(len(data))), data)
#plt.plot(t, ht)
#plt.plot(t, Q)
#plt.plot(t, [(I[t] - ht[t]).__float__() for t in range(len(t))])
dataI = [1.8107377807066435E-8, 0.26067711558345175, 0.7970896422971143, 0.6777504237410268, 0.7168550721078617, 0.7041346859905153, 0.7078919429340593, 0.7069548035425401, 0.7071052024302458, 0.7071304755089227, 0.7070891449562624, 0.7071165745550698, 0.7071020075885515, 0.7071089321937287, 0.7071058668403412, 0.7071071533970934, 0.7071066368792551, 0.7071068359398569, 0.7071067622838405, 0.707106788169162, 0.7071067796061241, 0.7071067823895807, 0.707106781488279, 0.7071067816881773, 0.7071067815552152, 0.7071067817350083, 0.707106781730447, 0.7071067818014862, 0.7071067817378487, 0.7071067816596588, 0.7071067817346965, 0.7071067816882457, 0.70710678157061, 0.7071067817063059, 0.7071067817284238, 0.7071067815563481, 0.7071067816347725, 0.7071067816108374, 0.7071067816871426, 0.7071067817327465, 0.7071067816290135, 0.707106781662505, 0.7071067817244203, 0.7071067816799999, 0.7071067817175782, 0.7071067816913352, 0.7071067817402428, 0.707106781556313, 0.7071067817366838, 0.7071067815936338, 0.7071067817701473, 0.7071067815762202, 0.7071067816331049, 0.7071067817364183, 0.7071067816427976, 0.7071067817262726, 0.707106781659022, 0.7071067815203098, 0.7071067817583678, 0.70710678166258, 0.7071067816202055, 0.7071067817342525, 0.7071067816736183, 0.7071067817115226, 0.7071067816797254, 0.707106781560777, 0.7071067817020547, 0.7071067816036498, 0.7071067817164449, 0.7071067815638865, 0.7071067816910639, 0.707106781814828, 0.7071067816932555, 0.707106781751079, 0.7071067817337715, 0.7071067816564911, 0.7071067815660572, 0.7071067816280245, 0.7071067815448155, 0.7071067815464658, 0.7071067814997951, 0.7071067817114587, 0.7071067816097569, 0.7071067816476009, 0.7071067816857495, 0.7071067815702947, 0.707106781693128, 0.7071067816027061, 0.7071067816790113, 0.70710678162208, 0.7071067817164072, 0.7071067817530747, 0.7071067815964467, 0.7071067816807819, 0.7071067818259573, 0.7071067817466208, 0.7071067815957504, 0.7071067815870875, 0.7071067816861931, 0.7071067817533132, 0.7071067816708827, 0.7071067815840815, 0.7071067815978886, 0.7071067817250389, 0.7071067815753498, 0.7071067816695322, 0.7071067816546113, 0.7071067817045456, 0.7071067817183474, 0.7071067816757877, 0.7071067815797805, 0.7071067817426013, 0.7071067817392702, 0.7071067816085246, 0.7071067817482244, 0.7071067816533767, 0.7071067817639385, 0.7071067815835299, 0.7071067817899968, 0.7071067816623082, 0.7071067817111683, 0.7071067815491068, 0.7071067816938212, 0.7071067817107939, 0.7071067815678114, 0.7071067816941046, 0.7071067816572412, 0.7071067817563024, 0.7071067816473726, 0.7071067817216581, 0.7071067815540117, 0.7071067816275503, 0.7071067816975183, 0.7071067816813277, 0.7071067816996068, 0.7071067816367202, 0.7071067815428105, 0.7071067817239389, 0.7071067817185828, 0.7071067817167318, 0.7071067816519214, 0.7071067817034047, 0.7071067816498564, 0.7071067817349799, 0.7071067816840202, 0.7071067816625058, 0.7071067816443639, 0.7071067815615106, 0.7071067816810812, 0.7071067817281897, 0.7071067816716359, 0.7071067817298995, 0.7071067817610355, 0.707106781636174, 0.7071067816547485, 0.7071067816121217, 0.7071067816053049, 0.7071067816849022, 0.7071067816466816, 0.7071067816708401, 0.707106781701123, 0.7071067817020813, 0.7071067816796694, 0.7071067815960412, 0.7071067816796206, 0.7071067816799839, 0.7071067816562184, 0.7071067815471688, 0.7071067816529477, 0.7071067817101429, 0.7071067816782568, 0.7071067816109822, 0.7071067816027443, 0.7071067817271981, 0.7071067818021044, 0.7071067817472261, 0.7071067817560266, 0.7071067816222514, 0.7071067817334531, 0.7071067817794088, 0.7071067816184762, 0.7071067816940961, 0.7071067817141432, 0.7071067816847347, 0.7071067816188532, 0.7071067816659027, 0.7071067816915395, 0.7071067816030729, 0.7071067816660057, 0.7071067817440237, 0.7071067817143621, 0.7071067816831333, 0.7071067817344079, 0.7071067817282195, 0.7071067817131493, 0.70710678164032, 0.7071067816655177, 0.7071067816139096, 0.7071067816843404, 0.7071067816632772, 0.7071067818508969, 0.7071067815888403, 0.7071067816404648, 0.7071067816857428
]

dataQ = [0.0, -0.13990646153753067, -0.528542756773875, -0.4443719893126211, -0.2560169685198859, 0.04579387263645251, 0.3254726147594493, 0.48537701663976257, 0.46491978926630156, 0.2716733382419357, -0.02238936472033652, -0.308188980654131, -0.4794921102247255, -0.4727106034993488, -0.29034592857093455, -1.3790069019586516E-6, 0.2909205885491207, 0.47291646720195696, 0.4782641119025108, 0.3027228980575906, 0.005229891548775328, -0.2883450067876584, -0.4810344869855034, -0.4680651652144569, -0.24254100483451183, 0.06897030200535534, 0.40344633028647997, 0.4958715082768237, 0.31693394598315466, 0.004636123137598958, -0.40070130992777286, -0.49729494885371583, -0.25689400351708563, 0.07989742495928964, 0.44479048790260584, 0.48665477397862367, 0.2034488503395763, -0.14819200631691035, -0.4479612492433677, -0.48520178807445885, -0.2531541577605757, 0.08875228439639295, 0.39214920821655685, 0.5011646229464704, 0.36508499487087315, 0.0611398089112624, -0.27195386014131745, -0.4779324346269931, -0.4614956287664939, -0.23180119500971005, 0.10537933402923153, 0.3937039999941637, 0.49977543743319536, 0.3744484682248588, 0.07576081910065512, -0.2580034478738602, -0.47150162904969084, -0.4699247652105097, -0.2674070483786612, 0.05133384509144969, 0.33460976702654954, 0.48008715782106276, 0.48008010988290006, 0.3343771894941442, 0.1437876614384396, 0.0047844152057207635, -0.17233960579392654, -0.15570743875067025, -0.28585807051325124, -0.13209869435398852, -0.2283755057523713, 0.040340879828572665, -0.11845420979242446, 0.24784799749103945, 0.010822088785724052, 0.3416319215987349, 0.09827430958973277, 0.29542350400930056, 0.03494442079862973, 0.08425372598032013, -0.19206954317559571, -0.26211040431568533, -0.4596975507557549, -0.49132306957298805, -0.4492625076351621, -0.2921391217240994, -0.04089270779900061, 0.21452345436443837, 0.4180066142601316, 0.4996461779625534, 0.4370289901469082, 0.24813267493346644, -0.012530613292093068, -0.26953895194099287, -0.44866134546139763, -0.4981008852157491, -0.4028603124245087, -0.18195018323173417, 0.08874449531055373, 0.362326228291619, 0.48824416947123894, 0.4252444937326231, 0.20415922741269077, -0.27059443332767, -0.4612422379572991, -0.24504729661457988, 0.06493217935830553, 0.39233037224791056, 0.1761077222530731, -0.32566473626190545, -0.12093494650181105, 0.13388412684040382, -0.18645196219208535, 0.07464264252137472, 0.47661824587367324, -0.17627361324416843, -0.5531782925479763, 0.12113000632928103, 0.5366913965335829, 0.16030799254441377, -0.2649764176065761, -0.4747388572545918, -0.4129348481745971, -0.21751624881259132, 0.03560169201844909, 0.09212596362102861, 0.15758068647404222, 0.06611401531246695, -0.10975337726371596, -0.12861264672586464, -0.5661659574674444, -0.05966502051371298, -0.037588495411267915, 0.008008790768627056, 0.5961939523864214, 0.13600901143311292, -0.04847512936506956, 0.011571487055478263, -0.44163276506732785, -0.20590733716821746, -0.3971109831366927, -0.14093417616611773, -0.03222397579759704, 0.30644490724921364, 0.5149737020172284, 0.28764561508837305, -0.3481975985588571, -0.28278374649408594, 0.37217672973505717, 0.250603379816587, -0.5863793031305458, -0.27264486839545693, 0.0640484058170188, -0.15620404544535016, 0.5604687711122225, 0.2565727515294773, -0.2460754351351431, 0.16383110145645302, -0.04068373298459118, -0.35217258674898777, -0.11906891601308052, 0.2573519879535378, 0.4748521553156519, 0.20004014564467204, -0.2937048664852197, -0.4836617118668694, -0.4146875844215301, -0.13500962715373263, 0.22045676445703694, 0.4569668898315982, 0.48102994242775493, 0.2830093344767274, -0.04641398109449486, -0.3541506606228295, -0.4980151566410378, -0.4112640143365568, -0.13412132652117173, 0.20479807465074049, 0.4412270465320054, 0.4906057971583807, 0.36737813331605185, 0.08558335130284797, -0.0913006316296661, -0.3355634621917202, -0.3312249031230552, -0.4442807193755707, -0.24456799894100553, -0.3418756232618979, 0.1200622489497547, 0.33471148453802324, -0.13889642085720283, 0.12094194773705118, 0.21879640717236154, -0.1531646276077207, -0.2325444212908718, 0.11038686821549837, 0.07988318146660234, -0.3571881939341946, 0.05631168546116118, 0.5398247591096249, 0.31432059567073295, 0.5142970969824799, 0.461596374168958]
plt.plot([i for i in range(len(dataI))], dataI)
plt.plot([i for i in range(len(dataQ))], dataQ)
#print([I[t] - ht[t] for t in range(len(t))])
#plt.plot(t, I)
plt.show()
